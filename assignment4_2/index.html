<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <title>Assignment#4-2 22200200 김창권</title>
</head>

<body>
  id : <input type="text" id="input_id" />
  name : <input type="text" id="input_name" />
  age : <input type="number" id="input_age" />
  hobby : <input type="text" id="input_hobby" />
  <label for="select_gender">gender : </label>
  <select name="gender" id="input_gender">
    <option value="Male">Male</option>
    <option value="Female">Female</option>
  </select>

  <button id="btn_list">목록 보기</button>
  <button id="btn_add">추가</button>
  <button id="btn_delete">삭제</button>
  <button id="btn_update">수정</button>

  <div id="div_list"></div>

  <!-- bootstrap modal에서 복사 붙여넣기 -->
  <div class="modal fade" id="crudModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <!-- title은 people -->
          <div class="modal-title" id="modalLabel">people</div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- id part -->
          <label>ID:</label>
          <input type="text" id="modal_input_id" class="form-control" readonly>
          <!-- name part -->
          <label>Name:</label>
          <input type="text" id="modal_input_name" class="form-control">
          <!-- age part -->
          <label>Age:</label>
          <input type="number" id="modal_input_age" class="form-control">
          <!-- hobby part -->
          <label>Hobby:</label>
          <input type="text" id="modal_input_hobby" class="form-control">
          <!-- gender part -->
          <label>Gender:</label>
          <select id="modal_input_gender" class="form-control">
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">close</button>
          <button type="button" class="btn btn-primary" id="btn_modal_save">save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function show_list() {
      const xhr = new XMLHttpRequest();
      xhr.open("GET", "https://6915287d84e8bd126af8d78e.mockapi.io/people/"); // 서버를 연다?
      xhr.setRequestHeader("content-type", "application/json");
      xhr.send(); // 실제로 전송
      xhr.onload = () => {
        if (xhr.status === 200) { // 제대로 받았으면
          let res = JSON.parse(xhr.response); // JSON 형식을 사용가능하게 변환4
          $("#div_list").html(""); // div_list 안에 있는 거 비우기
          res.forEach(function (each) { // res의 모든 원소 순환
            $("#div_list").append(`<div>${each.id} : ${each.name}[${each.age}](${each.gender}) hobby : ${each.hobby}</div>`);
          });
        }
        else {
          console.log(xhr.status, xhr.statusText);
        }
      }
    }
    $(function () {
      // js에서 modal 만드는 방법
      let crudModal = new bootstrap.Modal(document.getElementById('crudModal'));

      // 목록 보기
      $("#btn_list").click(function () {
        show_list();
      });

      // 추가
      $("#btn_add").click(function () {

        $("#btn_modal_save").data('mode', 'add'); // save 버튼 mode를 add로

        // 초기화
        $("#modal_input_id").val('');
        $("#modal_input_name").val('');
        $("#modal_input_age").val('');
        $("#modal_input_hobby").val('');
        $("#modal_input_gender").val('Male');

        crudModal.show(); // modal 보이게 하기
      });

      // 삭제
      $("#btn_delete").click(function () {

        const xhr = new XMLHttpRequest();
        xhr.open("DELETE", "https://6915287d84e8bd126af8d78e.mockapi.io/people/" + $("#input_id").val());
        // delete는 삭제, 뒤에 해당 id를 넣어줌
        xhr.setRequestHeader("content-type", "application/json");
        xhr.send();
        xhr.onload = () => {
          if (xhr.status === 200) {
            alert("삭제 되었습니다.");
            show_list();
          }
          else {
            console.log(xhr.status, xhr.statusText);
          }
        }
      });

      // 수정
      $("#btn_update").click(function () {
        const targetId = $("#input_id").val();

        if (!targetId) { // id 입력안하면
          alert("ID를 입력해주세요.");
          return;
        }

        $("#btn_modal_save").data('mode', 'update'); // save 버튼 mode를 update로

        // 데이터 채우기
        $("#modal_input_id").val(targetId).show();
        $("#modal_input_name").val($("#input_name").val());
        $("#modal_input_age").val($("#input_age").val());
        $("#modal_input_hobby").val($("#input_hobby").val());
        $("#modal_input_gender").val($("#input_gender").val());

        crudModal.show(); // modal 보이게 하기
      });

      // save 버튼, 여기서 실질적으로 서버에 데이터를 넘김
      $("#btn_modal_save").click(function () {
        const mode = $("#btn_modal_save").data('mode');

        const data = {
          id: $("#modal_input_id").val(),
          name: $("#modal_input_name").val(),
          age: $("#modal_input_age").val(),
          hobby: $("#modal_input_hobby").val(),
          gender: $("#modal_input_gender").val()
        };

        let httpMethod, url;

        if (mode === 'add') {
          httpMethod = "POST"; // 추가는 POST
          url = "https://6915287d84e8bd126af8d78e.mockapi.io/people/";
        } else if (mode === 'update') {
          httpMethod = "PUT"; // 수정은 PUT
          url = "https://6915287d84e8bd126af8d78e.mockapi.io/people/" + id; // +id를 함으로 해당 id 접근
        } else {
          return;
        }

        const xhr = new XMLHttpRequest();

        xhr.open(httpMethod, url); // 원하는 기능으로 서버 열기
        xhr.setRequestHeader("content-type", "application/json");
        xhr.send(JSON.stringify(data));

        xhr.onload = () => {
          if (xhr.status === 200 || xhr.status === 201) { // 처리 성공시
            alert("처리 완료");
            crudModal.hide();
            show_list();
          } else {
            console.error(`처리 실패 (${httpMethod}):`, xhr.status, xhr.statusText);
            alert(`처리 실패: ${xhr.status}`);
          }
        }
      });
    });
  </script>
</body>

</html>